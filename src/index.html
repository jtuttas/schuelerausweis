<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMBBS Ausweis App</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="/js/jsQR.js"></script>
    <script src="/js/service.js"></script>
    <style>
        .err {
            color: red;
            text-align: center;
        }
    </style>
</head>

<body>
    <script>
        var req = new XMLHttpRequest();
        req.open('GET', document.location, false);
        req.send(null);
        var key = req.getResponseHeader("key");
        console.log('key:' + key);

        var selectedDevice = "";
    </script>
    <h1>MMBbS Sch√ºlerausweis Scanner</h1>
    <h3>Angemeldet als
        <!--name-->
    </h3>
    <div class="row">

        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Video Source
                    <span class="caret"></span></button>
                <ul id="videosources" class="dropdown-menu">
                </ul>
            </div>
        </div>

    </div>
    <div id="loadingMessage">üé• Unable to access video stream (please make sure you have a webcam enabled)</div>
    <canvas id="canvas" hidden></canvas>
    <div id="errorMessage">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <p class="err" id="error"></p>
        </div>
    </div>
    <div id="results" class="row" hidden>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Attribut</th>
                        <th scope="col">Wert</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th scope="row">Name</th>
                        <td id="name"></td>
                    </tr>
                    <tr>
                        <th scope="row">Klasse</th>
                        <td id="klasse"></td>
                    </tr>
                    <tr>
                        <th scope="row">Geburtsdatum</th>
                        <td id="gebdat"></td>
                    </tr>
                    <tr>
                        <th scope="row">G√ºltigkeitsdatum</th>
                        <td id="gdat"></td>
                    </tr>
                    <tr>
                        <th scope="row">Diklabu ID</th>
                        <td id="did"></td>
                    </tr>
                    <tr>
                        <th scope="row">BBS Planung ID</th>
                        <td id="bpid"></td>
                    </tr>
                </tbody>
            </table>

            <button id="scan" type="button" class="btn btn-danger">Scan</button>

        </div>

    </div>
    <script>
        var video = document.createElement("video");
        var canvasElement = document.getElementById("canvas");
        var canvas = canvasElement.getContext("2d");
        var loadingMessage = document.getElementById("loadingMessage");
        var stopTicker = false;

        navigator.mediaDevices.enumerateDevices().then(function (devices) {
            for (var i = 0; i < devices.length; i++) {
                var device = devices[i];
                if (device.kind === 'videoinput') {
                    if (selectedDevice == "") {
                        selectedDevice = device.deviceId;
                    }
                    console.log('Device ' + device.label + "  id=" + device.deviceId);
                    $("#videosources").append('<li><a href="#" devid="' + device.deviceId + '" >' + device.label || 'camera ' + (i + 1) + '</a></li>');
                    /*
                    var option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || 'camera ' + (i + 1);
                    document.querySelector('select#videoSource').appendChild(option);
                    */
                }
            };
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function (stream) {
                video.srcObject = stream;
                video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                video.play();
                requestAnimationFrame(tick);
            });

            $(".dropdown-menu li a").click(function () {
                selectedDevice = $(this).attr("devid");
                console.log('Selected: ' + $(this).text() + " ID=" + selectedDevice);
                navigator.mediaDevices.getUserMedia({ video: { deviceId: selectedDevice } }).then(function (stream) {
                    video.srcObject = stream;
                    video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
                    video.play();
                    requestAnimationFrame(tick);
                });
            });

        });

        function drawLine(begin, end, color) {
            canvas.beginPath();
            canvas.moveTo(begin.x, begin.y);
            canvas.lineTo(end.x, end.y);
            canvas.lineWidth = 4;
            canvas.strokeStyle = color;
            canvas.stroke();
        }


        // Use facingMode: environment to attemt to get the front camera on phones
        /*
        navigator.mediaDevices.getUserMedia({ video: { facingMode: selectedDevice } }).then(function (stream) {

            video.srcObject = stream;
            video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
            video.play();
            requestAnimationFrame(tick);
        });
        */
        function tick() {
            loadingMessage.innerText = "‚åõ Loading video..."
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                loadingMessage.hidden = true;
                canvasElement.hidden = false;

                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                var code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                if (code) {
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
                    console.log('QR read:' + code.data);
                    stopTicker = true;
                    $("#errorMessage").hide();
                    rsaid = ""+code.data
                    rsaid=rsaid.substring(rsaid.indexOf("?id=")+4);
                    rsaid = decodeURI(rsaid);
                    rsaid=rsaid.replaceAll("%2B","+");
                    console.log('RSAID:'+rsaid);
                    data = {
                        id: rsaid
                    }
                    $.ajax
                        ({
                            type: "POST",
                            url: '/decode',
                            dataType: 'json',
                            headers: {
                                "key": key,
                                "content-type": "application/json"
                            },
                            async: false,
                            data: JSON.stringify(data),
                            success: function (e) {
                                canvasElement.hidden = true;
                                $("#results").show();
                                $("#name").text(e.vn + " " + e.nn);
                                $("#klasse").text(e.kl);
                                //$("#email").text(e.em);
                                
                                if (underage(e.gd)) {
                                    $("#gebdat").append('<p style="color:red;">'+e.gd+' (minderj√§hrig)</p>');
                                }
                                else {
                                    $("#gebdat").append('<p style="color:green;">'+e.gd+' (vollj√§hrig)</p>');

                                }
                                
                                if (expired(e.v)) {
                                    $("#gdat").append('<p style="color:red;">' + e.v + ' (abgelaufen)</p>');
                                }
                                else {
                                    $("#gdat").text(e.v);
                                }
                                $("#did").text(e.did);
                                $("#bpid").text(e.bpid);
                            },
                            error: function (xhr, status, error) {
                                var err = eval("(" + xhr.responseText + ")");
                                console.log('Error:' + error.Message);
                                stopTicker = false;
                                $("#errorMessage").show();
                                $("#error").text("Invalid QR Code");
                                //alert(err.Message);
                            }
                        })
                }
                else {
                    $("#error").text("No QR Code found");
                }
            }
            if (stopTicker == false) {
                requestAnimationFrame(tick);
            }
        }

        $("#scan").click(function (e) {
            stopTicker = false;
            canvasElement.hidden = false;
            $("#errorMessage").show();
            $("#results").hide();
            requestAnimationFrame(tick);

        });



    </script>
</body>

</html>